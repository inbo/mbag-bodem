---
title: "Annelida data analyse"
author: "Sam Lambrechts, Io Deflem, Emma Cartuyvels, Hans Van Calster"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
library(here)
opts_chunk$set(echo = TRUE)
opts_knit$set(root.dir = here::here())

if (!"phyloseq" %in% rownames(installed.packages())) {
  remotes::install_github("joey711/phyloseq")
}
library(phyloseq)
library(vegan)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(gridExtra)
library(ggbiplot)
library(factoextra)
library(dplyr)
library(rstatix)
library(dunn.test)
library(compositions)

#### Handig pakket met veel phyloseq add-ons
#install.packages("remotes")
if (!"psadd" %in% rownames(installed.packages())) {
  remotes::install_github("cpauvert/psadd")
}

library(psadd)
library(googledrive)
googledrive::drive_auth(email = "*@inbo.be")

mbag_folder <- "G:/Gedeelde drives/PRJ_MBAG"
```

# Inlezen data

```{r shared-drive-data-folders}
sdf <- shared_drive_find("PRJ_MBAG") %>%
  drive_ls(pattern = "4c_bodem", type = "folder") %>%
  drive_ls(pattern = "data", type = "folder") %>%
  drive_ls(pattern = "statistiek", type = "folder") %>%
  drive_ls(pattern = "Annelida", type = "folder")
```

```{r rdata-file-path}
rdata_dribble <- sdf %>%
  drive_ls(pattern = "^phyloseq_Olig01_Annelida$", type = "folder") %>%
  drive_ls("physeq_Olig01_Annelida_species.Rdata") %>%
  drive_reveal(what = "path")
```

```{r load-rdata-file}
load(file.path(mbag_folder, rdata_dribble$path))
```


# Verkennende analyses

## Alfa-diversiteit

### Preprocessing stappen

<!--vergeet HIER niet te starten van de NIET-rarefied versie-->

Link: https://jacobrprice.github.io/2017/08/26/phyloseq-to-vegan-and-back.html

Check totaal aantal reads (hier de decielen van 0% = minimum tot 100% = maximum):

```{r quantiles-reads}
sample_sums(physeq_Olig01_Annelida_species) %>%
  quantile(probs = seq(0, 1, 0.1))
```


```{r}
## Pick whatever dataset you want to work with

physeq <- physeq_Olig01_Annelida_species

# physeq <- physeq_18S_Annelida

```

Remove samples according to the dataset you want to work with (e.g. without replicates or without a certain land use type)



```{r selectie-taxongroep}
physeq <- subset_taxa(physeq, phylum =="Annelida")

```

```{r }
sample_sums(physeq) %>%
  quantile(probs = seq(0, 1, 0.1))
```


```{r verken-object}
physeq

glimpse(sample_data(physeq) %>% as_tibble())
```


Voorbereidende stap: convert the otu_table() within a phyloseq object to a vegan compatible data object

```{r psotu2veg-function}
psotu2veg <- function(physeq) {
  OTU <- otu_table(physeq)
  if (taxa_are_rows(OTU)) {
    OTU <- t(OTU)
  }
  return(as(OTU, "matrix"))
}

veganobject <- psotu2veg(physeq)
```


### Rarefaction analyse 

Schatting van de soortenrijkdom via rarefaction analyse.

```{r rarefaction}
sam.new <- data.frame(sample_data(physeq))


Estimated_species_richness <- vegan::rarefy(
  veganobject,
  30780,
  se = FALSE,
  MARGIN = 1)

true_rarefaction_results <- cbind(sam.new, Estimated_species_richness)
```

plot results land use types


```{r raref-landgebruik}
ggplot(
  true_rarefaction_results,
  aes(x = stringr::str_wrap(Landgebruik_MBAG, width = 15),
      y = Estimated_species_richness)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = mean_cl_boot, col = "red") +
  labs(y = "Expected species richness\n(Annelida(Olig01)",  
       x = "Landgebruik")
```

```{r raref-diepte}
ggplot(
  true_rarefaction_results,
  aes(x = Diepte,
      y = Estimated_species_richness)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = mean_cl_boot, col = "red") +
  labs(y = "Expected species richness (Annelida(Olig01))",
       x = "Diepte")
```

### Statistische testen

Opmerking: heel deze sectie beter vervangen door een regressiemodel.

```{r test-normaliteit}
shapiro.test(true_rarefaction_results$Estimated_species_richness)
# is p-value van de shapiro test hierboven kleiner dan 0.05, dan is de data niet normaal verdeeld en doen we kruskal-wallis
```

```{r kw-test}
kruskal_test(
  true_rarefaction_results,
  Estimated_species_richness ~ Landgebruik_MBAG
)
kruskal_test(
  true_rarefaction_results,
  Estimated_species_richness ~ Diepte)

```


```{r post-hoc-test}
# Define the variable for which you found a significant difference
variable_of_interest <- "Landgebruik_MBAG"  # Replace with the variable name

# Perform the Kruskal-Wallis test
kruskal_result <- kruskal_test(true_rarefaction_results, Estimated_species_richness ~ get(variable_of_interest))


# Perform the Dunn post-hoc test with Benjamini-Hochberg correction
dunn_result <- dunn.test(
  true_rarefaction_results$Estimated_species_richness,
  true_rarefaction_results[[variable_of_interest]],
  method = "bh")

# Display the Dunn test results
data.frame(
  comparison = dunn_result$comparisons,
  p_adjusted = dunn_result$P.adjusted) %>%
  kable(digits = 4)
```

Identify Groups with Highest/Lowest Alpha Diversity: You can also extract specific values if you want to determine which group has the highest or lowest estimated species richness.
For example, you can use the summary function to compute summary statistics and identify the group with the maximum or minimum mean estimated species richness:


```{r}
# Find the group with the highest estimated species richness
true_rarefaction_results %>%
  as_tibble() %>%
  group_by(Landgebruik_MBAG) %>%
  summarise(
    min = min(Estimated_species_richness),
    p25 = quantile(Estimated_species_richness, probs = 0.25),
    mediaan = median(Estimated_species_richness),
    mean = mean(Estimated_species_richness),
    p75 = quantile(Estimated_species_richness, probs = 0.75),
    max = max(Estimated_species_richness)
  ) %>%
  kable()
```


### Rarefaction curves

Werkt nog niet

```{r rarefaction-curves, eval=FALSE}
S <- specnumber(veganobject)

raremax <- min(rowSums(veganobject))

rarecurve(
  veganobject,
  step = 1000,
  sample = raremax,
  col = "blue",
  cex = 0.6)
```


## OTU counts 

per phylum

```{r per-phylum}
# Count OTUs per Phylum
tax_table(physeq) %>%
  as.data.frame() %>%
  as_tibble() %>%
  group_by(phylum) %>%
  summarise(OTU_Count = n()) %>%
  kable()
```

Per genus

```{r per-genus}
tax_table(physeq) %>%
  as.data.frame() %>%
  group_by(genus) %>%
  summarise(OTU_Count = n()) %>%
  arrange(desc(OTU_Count)) %>%
  kable()
```

Per species (check of er species zijn met meer dan 1 OTU)

```{r per-species}
tax_table(physeq) %>%
  as.data.frame() %>%
  group_by(species) %>%
  summarise(OTU_Count = n()) %>%
  filter(OTU_Count > 1) %>%
  kable()
```


## Read counts

Hier loopt nog iets mis.

```{r eval=FALSE}
physeq %>%
  tax_glom(taxrank = "family") %>%
  otu_table() %>%
  as.data.frame() %>%
  as_tibble() %>%
  group_by(phylum) %>%
  summarise(Read_Count = sum(!!sym(colnames(.))))

```

## How to remove unwanted OTUs from phyloseq object

```{r function-prune-taxa}
pop_taxa = function(physeq, badTaxa){
  allTaxa = taxa_names(physeq)
  allTaxa <- allTaxa[!(allTaxa %in% badTaxa)]
  return(prune_taxa(allTaxa, physeq))
}

badTaxa = c("Zotu511")
physeq <- pop_taxa(physeq, badTaxa)

physeq


```

## Ordinatie

```{r physec-rarefied}
physeq_rarefied <- rarefy_even_depth(physeq, sample.size = 30780)
```

```{r ordination-vegan}
ordmat <- psotu2veg(physeq_rarefied)

all(colSums(ordmat) > 0)
all(rowSums(ordmat) > 0)
all(ordmat >= 0)

ordmat <- decostand(ordmat, method = "rclr")

samples <- sample_data(physeq_rarefied) %>%
  as.data.frame() %>%
  as_tibble()

rda <- rda(ordmat)

biplot(rda)


```


```{r eval=FALSE}
# Perform CLR transformation
clr_physeq_rarefied <- transform(physeq_rarefied, "clr")

# Calculate Bray distance matrix based on the CLR-transformed data
bray_distance <- distance(physeq, method = "bray")

# Perform PCoA
pcoa_result <- ordinate(physeq, method = "PCoA", distance = "bray")

# Create the ordination plot with color based on land_use and shape based on diepte
plot_ordination(physeq, pcoa_result, type = "samples", color = "Landgebruik_MBAG", shape = "Diepte") +
  theme_minimal()





```

